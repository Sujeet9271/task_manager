{% load static %}
<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" type="image/x-icon" href="{% static 'images/task_master.png' %}">
		<title>TaskMaster</title>
		<link rel="stylesheet" href="{% static 'assets/bootstrap/css/bootstrap.min.css' %}" />
		<link rel="stylesheet" href="{% static 'assets/fontawesome/css/all.min.css' %}" />
		<link rel="stylesheet" href="{% static 'css/styles.css' %}" />
		<script src="{% static 'assets/htmx/js/htmx.min.js' %}"></script>
		<script src="{% static 'js/common.js' %}"></script>
		<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

	</head>

	<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}' hx-indicator='.gif_loader'>
		<div class="navbar">
			<div class="navbar-brand">
				<a href="{% url 'workspace:index' %}">
					<img src="{% static 'images/task_master.png' %}" alt="TaskMaster Logo" class="navbar-logo">
				</a>
			</div>
		
			<div class="navbar-links">
				<!-- Notification Button -->
				<div class="notifications">
					<span class="notification-button">
						<i class="fa-solid fa-bell"></i>
						{% if unread_notification_count > 0 %}
							<span id="unread_notification_count" class="notification-count">
								{{ unread_notification_count }}
							</span>
						{% endif %}
					</span>
				</div>
		
				<!-- User Info and Logout Button -->
				<div class="user-info">
					<span>Welcome, {{ user.username }}</span>
					<form method="post" action="{% url 'accounts:logout-user' %}">
						{% csrf_token %}
						<button class="logout-btn" type="submit">
							<i class="fa-solid fa-right-from-bracket"></i>
						</button>
					</form>
				</div>
			</div>
		</div>
		
		<!-- Notifications Dropdown (Initially Hidden) -->
		<div id="notification-div" class="notification-dropdown fade">
			<div id="notification-list">
				{% include 'notifications/notification_list.html' with notifications=notifications %}
			</div>
			<div class="notification-loader"><div></div><div></div><div></div></div>
		</div>

		<div id="loader">
			<div id="loader_div">
			<img src="{% static 'gif/gif.gif' %}" alt="gif">
			</div>
		</div>
	
		<div class="custom-container">
		<div class="sidebar" id="boards-sidebar">
			<div class="add" id="add-board-btn"
				data-bs-toggle="modal"
				data-bs-target="#createBoard"
				>
			+ Add New Board
			</div>
			<div id="boards">
			{% for board in boards %}
			{% include 'boards/components/board_list_item.html' with board=board %}
			{% endfor %}
			</div>
		</div>
	
		<div class="main-content" id="main-content">
			{% if board %}
			{% include "boards/components/board.html" with board=board %}
			{% else %}
			<div class="welcome-illustration">
				<img src="{% static 'images/welcome.svg' %}" alt="Welcome" />
				<h1>Welcome to TaskMaster</h1>
				<p>Select a board to view its content or create a new one!</p>
			</div>
			{% endif %}
		</div>
		</div>

		<div class="modal fade" id="createBoard" tabindex="-1" aria-labelledby="createBoardLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="createBoardLabel">Add New Board</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="close_createBoardModal"></button>
					</div>
					<div class="modal-body" id="modal-board-body">
						<form hx-post="{% url 'board:board-create' %}" hx-target="#boards" hx-swap="beforeend" id="create_board_form" method="POST" action="{% url 'board:board-create' %}">
							{% csrf_token %}
							<div class="mb-3">
								<label for="board_name" class="form-label">Board Name</label>
								<input type="text" class="form-control" id="board_name" name="name" required>
								<input type="hidden" class="form-control" id="workspace_id" name="workspace_id" value="{{workspace_id}}">
							</div>
							<div class="modal-footer">
								<button type="submit" class="btn btn-primary">Create</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="createColumnModal" tabindex="-1" aria-labelledby="createColumnModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="createColumnModalLabel">Add New Column</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="close_createColumnModal"></button>
					</div>
					<div class="modal-body" id="modal-column-body">
						
					</div>
					
				</div>
			</div>
		</div>

		<div class="modal fade" id="editTaskModal" tabindex="-1" role="dialog" aria-labelledby="editTaskModalLabel" aria-hidden="true">
			<div class="modal-dialog  modal-xl" role="document">
				<div class="modal-content">
					<div class="modal-header">
					<h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
					</div>
					<div class="modal-body" id="edit_task_modal">
					Editing task content here.
					</div>
				</div>
			</div>
		</div>
	</body>
	<script src="{% static 'assets/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
	<script src="{% static 'js/board_index.js' %}"></script>
	<script>
		const users = [
			{% for user in users %}
				'{{ user.username }}',
			{% endfor %}
		];
		
		htmx.on('htmx:afterSwap', (evt) => {
			if(evt.target.id=="notification-list"){
				var tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
				var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
					return new bootstrap.Tooltip(tooltipTriggerEl)
				})
			}else if(evt.target.id=="edit_task_modal"){
				mentionable_users = document.getElementById('mentionable_users').value.split(",")
				chatInput = document.getElementById('chatInput');
				mentionBox = document.getElementById('mentionSuggestions');
				let currentMentionStart = -1;
			
				chatInput.addEventListener('input', (e) => {
					let caretPos = chatInput.selectionStart;
					let text = chatInput.value;
					let lastAt = text.lastIndexOf('@', caretPos - 1);
				
					// If '@' is found, show mention suggestions
					if (lastAt !== -1 && (lastAt === 0 || /\s/.test(text[lastAt - 1]))) {
						let query = text.substring(lastAt + 1, caretPos).toLowerCase();
				
						// Filter users based on query
						let matches = mentionable_users.filter(username => username.toLowerCase().includes(query));
				
						// If there are matches, show the mention box
						if (matches.length > 0) {
							mentionBox.innerHTML = matches.map(username =>
								`<li class="list-group-item list-group-item-action" data-username="${username}">@${username}</li>`
							).join('');
							mentionBox.classList.remove('d-none');
						} else {
							mentionBox.classList.add('d-none');
						}
					} else {
						mentionBox.classList.add('d-none');
					}
				});
				
			
				// Click to select a mention
				mentionBox.addEventListener('click', (e) => {
					if (e.target.dataset.username) {
						let text = chatInput.value;
						let caretPos = chatInput.selectionStart;
						let before = text.substring(0, currentMentionStart);
						let after = text.substring(caretPos);
			
						chatInput.value = `${before}@${e.target.dataset.username} ${after}`;
						chatInput.focus();
						mentionBox.classList.add('d-none');
					}
				});
			
				// Hide on click outside
				document.addEventListener('click', (e) => {
					if (!mentionBox.contains(e.target) && e.target !== chatInput) {
						mentionBox.classList.add('d-none');
					}
				});
			}else if(evt.target.id=='main-content'){
				initDragAndDrop(); // Call reusable init function
			}

		});
		
		function initDragAndDrop() {
			console.log('here')
			const taskCards = document.querySelectorAll('.task-card');
			const dropzones = document.querySelectorAll('.dropzone');
		
			taskCards.forEach(card => {
				card.addEventListener('dragstart', (e) => {
				e.dataTransfer.setData('text/plain', card.dataset.taskId);
				});
			});
			
			dropzones.forEach(zone => {
				zone.addEventListener('dragover', (e) => {
					e.preventDefault();
					zone.classList.add('bg-light');
				});
			
				zone.addEventListener('dragleave', () => {
					zone.classList.remove('bg-light');
				});
			
				zone.addEventListener('drop', (e) => {
					e.preventDefault();
					const taskId = e.dataTransfer.getData('text/plain');
					const columnId = zone.dataset.columnId;
				
					fetch(`/board/tasks/${taskId}/move/`, {
						method: 'POST',
						headers: {
							'X-CSRFToken': getCookie('csrftoken'),
							'Content-Type': 'application/x-www-form-urlencoded',
						},
						body: `column_id=${columnId}`,
					}).then(response => {
						if (!response.ok) {
							throw new Error('Failed to move task');
						}
						return response.json();
					}).then(data => {
						const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
						zone.appendChild(taskCard);
					
						// Assuming data.urls is an object like { "edit": { id: 1, url: "/edit/1/" }, ... }
						Object.keys(data.urls).forEach(key => {
							const element = document.getElementById(key);
							Object.keys(data.urls[key]).forEach(method=>{
								url = data.urls[key][method]
								if (element) {
									element.setAttribute(`hx-${method}`, url);
									htmx.process(element)
									console.log(element)
								}
							})
						});
					}).catch(error => {
						console.error(error);
						alert('Failed to move task');
					}).finally(() => {
						zone.classList.remove('bg-light');
					});					
				},{ once: true });
			});
		}
		
		// Utility function to get CSRF token
		function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let cookie of cookies) {
			cookie = cookie.trim();
			if (cookie.startsWith(name + '=')) {
				cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
				break;
			}
			}
		}
		return cookieValue;
		}
		  
		// Call on initial page load too
		document.addEventListener('DOMContentLoaded', initDragAndDrop);
	
		
	
		
	</script>
	
	
</html>